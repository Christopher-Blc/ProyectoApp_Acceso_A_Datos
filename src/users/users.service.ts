// Importamos el decorador Injectable para poder inyectar este servicio en otros m√≥dulos
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

// Importamos la entidad User, que representa la tabla en la base de datos
import { User } from './user.entity';

// El decorador @Injectable() le dice a Nest que esta clase puede ser inyectada
// en otras clases (por ejemplo, en el controlador)
@Injectable()
export class UsersService {
  // En el constructor, declaramos las dependencias que queremos que NestJS inyecte autom√°ticamente.
  // En este caso, el repositorio de la entidad User.
  constructor(
    // @InjectRepository(User) indica que queremos el repositorio de esta entidad.
    // NestJS crear√° una instancia del repositorio correspondiente y la inyectar√° aqu√≠.
    @InjectRepository(User)
    private readonly userRepository: Repository<User>, // Repositorio gen√©rico de TypeORM para la entidad User
  ) {}

  // üîπ M√©todo para obtener todos los usuarios
  async findAll(): Promise<User[]> {
    // Llamamos al m√©todo find() de TypeORM para traer todos los usuarios
    // Incluimos las relaciones (por ejemplo, las reservas del usuario)
    return this.userRepository.find({ relations: ['reservas', 'membresia', 'pago', 'comentario'] });
  }

  // üîπ M√©todo para obtener un usuario por su ID
  async findOne(usuario_id: number): Promise<User> {
    // findOne busca un registro que cumpla la condici√≥n `where: { id }`
    // Tambi√©n cargamos las reservas relacionadas con ese usuario
    const user = await this.userRepository.findOne({
      where: { usuario_id: usuario_id },
      relations: ['reservas', 'membresia', 'pago', 'comentario'],
    });
    if (!user) {
      throw new Error(`Usuario ${usuario_id} no encontrado`); // Lanzamos un error si no se encuentra el usuario
    }
    return user;
  }

  // M√©todo para crear un nuevo usuario
  async create(data: Partial<User>) {
    // "create" crea una instancia del objeto User (no la guarda todav√≠a)
    const user = this.userRepository.create(data);
    // "save" guarda el usuario en la base de datos
    return this.userRepository.save(user);
  }

  // M√©todo para actualizar un usuario existente
  async update(usuario_id: number, data: Partial<User>) {
    // "update" modifica los campos en la base de datos
    await this.userRepository.update(usuario_id, data);
    // Retornamos el usuario actualizado
    return this.findOne(usuario_id);
  }

  // üîπ M√©todo para eliminar un usuario por ID
  async remove(usuario_id: number): Promise<void> {
    // Borramos el registro que tenga el ID indicado
    await this.userRepository.delete(usuario_id);
  }
}
